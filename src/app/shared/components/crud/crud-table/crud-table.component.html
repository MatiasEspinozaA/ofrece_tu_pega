<div class="crud-table-container">
  <!-- Header -->
  <div class="crud-header">
    <div class="crud-title">
      <h2>{{ config.title }}</h2>
      <span class="record-count">{{ filteredData().length }} registros</span>
    </div>

    <div class="crud-actions">
      @if (config.showSearch) {
        <mat-form-field appearance="outline" class="search-field">
          <mat-icon matPrefix>search</mat-icon>
          <input
            matInput
            placeholder="Buscar..."
            [(ngModel)]="searchTerm"
            (ngModelChange)="onSearchChange()"
          />
        </mat-form-field>
      }

      @if (config.showExport) {
        <button mat-icon-button matTooltip="Exportar" [matMenuTriggerFor]="exportMenu">
          <mat-icon>download</mat-icon>
        </button>
      }

      @if (config.showCreate) {
        <button
          mat-raised-button
          color="primary"
          (click)="onCreate.emit()"
        >
          <mat-icon>add</mat-icon>
          Crear nuevo
        </button>
      }
    </div>
  </div>

  <!-- Table -->
  <div class="table-wrapper">
    <table
      mat-table
      [dataSource]="paginatedData()"
      matSort
      (matSortChange)="onSortChange($event)"
      class="crud-table"
    >
      <!-- Dynamic Columns -->
      @for (column of config.columns; track column.key) {
        <ng-container [matColumnDef]="column.key.toString()">
          <th
            mat-header-cell
            *matHeaderCellDef
            [mat-sort-header]="column.sortable !== false ? column.key.toString() : ''"
            [style.width]="column.width"
            [style.text-align]="column.align || 'left'"
          >
            {{ column.label }}
          </th>
          <td
            mat-cell
            *matCellDef="let row"
            [style.text-align]="column.align || 'left'"
          >
            @switch (column.type) {
              @case ('image') {
                @if (getCellValue(row, column.key)) {
                  <img
                    [src]="getCellValue(row, column.key)"
                    [alt]="column.label"
                    class="cell-image"
                  />
                } @else {
                  <mat-icon class="no-image">image_not_supported</mat-icon>
                }
              }
              @case ('boolean') {
                <mat-icon [class.active]="getCellValue(row, column.key)">
                  {{ getCellValue(row, column.key) ? 'check_circle' : 'cancel' }}
                </mat-icon>
              }
              @case ('badge') {
                <mat-chip class="status-chip">
                  {{ formatCellValue(row, column) }}
                </mat-chip>
              }
              @case ('date') {
                {{ formatCellValue(row, column) || (getCellValue(row, column.key) | date:'dd/MM/yyyy') }}
              }
              @default {
                {{ formatCellValue(row, column) || getCellValue(row, column.key) }}
              }
            }
          </td>
        </ng-container>
      }

      <!-- Actions Column -->
      @if (hasActions()) {
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef style="width: 120px; text-align: center">
            Acciones
          </th>
          <td mat-cell *matCellDef="let row" style="text-align: center">
            <div class="action-buttons">
              @if (config.showEdit) {
                <button
                  mat-icon-button
                  color="primary"
                  matTooltip="Editar"
                  (click)="onEdit.emit(row)"
                >
                  <mat-icon>edit</mat-icon>
                </button>
              }

              @if (config.showDelete) {
                <button
                  mat-icon-button
                  color="warn"
                  matTooltip="Eliminar"
                  (click)="onDelete.emit(row)"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              }

              @if (config.actions && config.actions.length > 0) {
                @for (action of config.actions; track action.label) {
                  @if (!action.show || action.show(row)) {
                    <button
                      mat-icon-button
                      [color]="action.color || 'primary'"
                      [matTooltip]="action.tooltip || action.label"
                      (click)="action.handler(row)"
                    >
                      <mat-icon>{{ action.icon }}</mat-icon>
                    </button>
                  }
                }
              }
            </div>
          </td>
        </ng-container>
      }

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns" class="table-row"></tr>

      <!-- Empty State -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell empty-state" [attr.colspan]="displayedColumns.length">
          <div class="empty-content">
            <mat-icon>inbox</mat-icon>
            <p>{{ config.emptyMessage || 'No hay registros para mostrar' }}</p>
          </div>
        </td>
      </tr>
    </table>
  </div>

  <!-- Paginator -->
  @if (data.length > (config.defaultPageSize || 10)) {
    <mat-paginator
      [length]="filteredData().length"
      [pageSize]="pageSize"
      [pageSizeOptions]="config.pageSizeOptions || [5, 10, 25, 50]"
      (page)="onPageChange($event)"
      showFirstLastButtons
    >
    </mat-paginator>
  }
</div>

<!-- Export Menu -->
<mat-menu #exportMenu="matMenu">
  <button mat-menu-item (click)="exportToCSV()">
    <mat-icon>table_chart</mat-icon>
    <span>Exportar a CSV</span>
  </button>
  <button mat-menu-item (click)="exportToJSON()">
    <mat-icon>code</mat-icon>
    <span>Exportar a JSON</span>
  </button>
</mat-menu>
